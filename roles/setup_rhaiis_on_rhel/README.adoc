= Setup RHAIIS on RHEL Role

This Ansible role installs and configures Red Hat AI Inference Server (RHAIIS) on Red Hat Enterprise Linux systems.

== Features

* Automatic NVIDIA Container Toolkit installation
* Container registry authentication support (username/password or token)
* Intelligent user detection for multi-user environments
* vLLM service configuration with systemd
* Health check monitoring

== Variables

=== Core Configuration

* `setup_rhaiis_on_rhel_hf_token`: HuggingFace token for model access
* `setup_rhaiis_on_rhel_api_token`: API token for accessing the deployed model
* `setup_rhaiis_on_rhel_vllm_model`: Hugging Face model to deploy
* `setup_rhaiis_on_rhel_vllm_port`: Port for the vLLM service (default: 8000)

=== User Management

* `setup_rhaiis_on_rhel_target_user`: Target user for running services
  ** Auto-detects the SSH user (`ansible_user` or `ansible_user_id`)
  ** Falls back to `ec2-user` if detection fails
  ** Can be overridden in variables if needed
  ** Supports common cloud users: `ec2-user`, `ubuntu`, `centos`, `cloud-user`

=== Registry Authentication

* `setup_rhaiis_on_rhel_registry_auth_enabled`: Enable registry authentication (default: true)
* `setup_rhaiis_on_rhel_registry_url`: Registry URL (default: registry.redhat.io)
* `setup_rhaiis_on_rhel_registry_username`: Registry username
* `setup_rhaiis_on_rhel_registry_password`: Registry password
* `setup_rhaiis_on_rhel_registry_auth_token`: Alternative token-based authentication

== Example Usage

[source,yaml]
----
- hosts: rhel_servers
  become: true
  vars:
    setup_rhaiis_on_rhel_hf_token: "your-huggingface-token"
    setup_rhaiis_on_rhel_registry_username: "your-registry-user"
    setup_rhaiis_on_rhel_registry_password: "your-registry-password"
    setup_rhaiis_on_rhel_vllm_model: "RedHatAI/Llama-3.1-8B-Instruct"
  roles:
    - setup_rhaiis_on_rhel
----

== Improvements from Previous Version

* **Smart User Detection**: Automatically detects the SSH user instead of hardcoding `ec2-user`
* **Cleaner Variable Names**: `setup_rhaiis_on_rhel_target_user` instead of `student_name`
* **Reduced Duplication**: Single variable definition instead of repeated defaults
* **Better Documentation**: Clear variable purposes and fallback behavior

== Requirements

* RHEL 9.5 target server
* NVIDIA GPU(s)
* Podman installed on the target system
* Ansible 2.9 or newer

== Role Variables

All variables are defined in `defaults/main.yml`:

[cols="1,2,1", options="header"]
|===
|Variable |Description |Default Value

|`hf_token`
|Hugging Face API token
|"secret"

|`vllm_cache_dir`
|Directory for vLLM cache
|"/home/{{ student_name | default('dev') }}/.cache/vllm"

|`vllm_port`
|Port to expose vLLM service
|8000

|`vllm_tensor_parallel_size`
|Tensor parallel size for vLLM
|1

|`vllm_max_model_len`
|Maximum model length
|8192

|`vllm_model`
|Model to use with vLLM
|"Groq/Llama-3-Groq-8B-Tool-Use"

|`vllm_container_name`
|Name for the container
|"vllm"

|`vllm_container_image`
|Container image to use
|"secret"

|`vllm_user`
|User to run the vLLM service
|`{{ ansible_user_id }}`

|`registry_auth_enabled`
|Enable container registry authentication
|true

|`registry_url`
|Container registry URL
|"quay.io"

|`registry_username`
|Username for registry authentication
|""

|`registry_password`
|Password for registry authentication
|""

|`registry_auth_token`
|Authentication token for registry (alternative to username/password)
|""

|`vllm_health_check_retries`
|Number of health check retries
|30 (30 mins total)

|`vllm_health_check_delay`
|Seconds between health check retries
|30

|`vllm_health_endpoint`
|API endpoint to check for health
|"/v1/models"
|===

== Example Playbook

[source,yaml]
----
---
- hosts: gpu_servers
  become: true
  roles:
    - role: setup_rhaiis_on_rhel
      vars:
        hf_token: "your_actual_hugging_face_token"
        # Increase health check timeout for slower networks
        vllm_health_check_retries: 120  # 1 hour total wait time
----

=== Using a Registry Authentication Token

If you prefer to use a token instead of username/password:

[source,yaml]
----
---
- hosts: gpu_servers
  become: true
  roles:
    - role: setup_rhaiis_on_rhel
      vars:
        registry_auth_token: "your_registry_token"
----

== Role Structure

[source]
----
setup_rhaiis_on_rhel/
├── defaults/
│   └── main.yml
├── handlers/
│   └── main.yml
├── tasks/
│   ├── main.yml
│   ├── configure_registry_auth.yml
│   └── create_systemd_service.yml
├── templates/
│   └── rhaiis.service.j2
└── README.adoc
----

== Container Registry Authentication

This role configures Podman authentication for both the root user and the service user, allowing:

* Pre-pulling of the container image before starting the service
* Authentication with username/password or token
* Separate configuration for root and service users

When enabled (which is the default), you must provide either:

* `registry_username` and `registry_password`, or
* `registry_auth_token`

== Service Health Check

This role includes a health check that:

. Waits for the RHAIIS service to fully start (including image downloads)
. Checks the API endpoint to ensure the service is responding correctly
. Verifies the systemd service status
. Confirms the container is running

[IMPORTANT]
====
If any of these checks fail after the configured retry period, the playbook will fail with an error message.
====

== Author Information

Nate Stephany
nate@redhat.com
